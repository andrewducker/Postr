 <div id="dwCredentials" title="Dreamwidth Details">
	<form>
		<label for=dwUsername>User Name:</label> <input type="text" id="dwUsername" name="username"><BR>
		<label for=dwPassword>Password:</label> <input type="password" id="dwPassword" name="password"><BR>
		<button type="button" id="dwCredentialsVerify">Verify</button><BR>
		<div id="dwIdentity"></div><BR>
		<label for=dwTimeZone>Time Zone:</label><input type=text id="dwTimeZone">
	</form>
 </div>

<div id="dwResults" title="Dreamwidth Details Updated">
	 <div id="dwResultsText"><h2>Did it work?</h2></div>
</div>

<script type="text/javascript">

dreamwidth = new Object();

dreamwidth.sitename = "Dreamwidth";

dreamwidth.saveCredentials = function(){
	if($("#dwIdentity").text() != ""){
		var params = {method:"SaveData", username:$("#dwUsername").val(), password:$("#dwPassword").val(), timezone:$("#dwTimeZone").val()};
		var posting = $.post("dreamwidth",{params:JSON.stringify(params)});
		wizards.registerCallForWizardDisplay(posting,"dwResultsText","dwResults").done(function(data){
			data.siteName = dreamwidth.sitename;
			data.username = params.username;
			data.timezone = params.timezone;
			dreamwidth.currentDeferral.resolve(data);
		});
	}
	else{
		wizards.showError("Identity not validated");
	}
}

dreamwidth.updateCredentials = function(){
	if($("#dwIdentity").text() != ""){
		var params = {method:"UpdateData", password:$("#dwPassword").val(), timezone:$("#dwTimeZone").val(), key:dreamwidth.currentOutput};
		var posting = $.post("dreamwidth",{params:JSON.stringify(params)});
		wizards.registerCallForWizardDisplay(posting,"dwResultsText","dwResults").done(function(data){
			data.timezone = params.timezone;
			dreamwidth.currentDeferral.resolve(data);
		});
	}
	else{
		wizards.showError("Identity not validated");
	}
}

wizards.register("#dwCredentials",{buttons: [{text:"ok", click: dreamwidth.saveCredentials}]});
wizards.register("#dwResults",{buttons: [{text:"Done", click: function(){wizards.closeAllPages()}}]});

dreamwidth.AddOutput = function(){
	$("#dwIdentity").text("");
	$("#dwTimeZone").val("");
	$("#dwPassword").val("");
	$("#dwUsername").val("");
	$("#dwUsername").removeProp('disabled');
	var buttons = $( "#dwCredentials" ).dialog( "option", "buttons", [{text:"ok", click: function(){dreamwidth.saveCredentials()}}]);
	dreamwidth.currentDeferral = $.Deferred();
	wizards.showPage("dwCredentials");
	return dreamwidth.currentDeferral;
}

dreamwidth.RemoveOutput = function(key){
	var params = {method:"RemoveData", key:parseInt(key)};
	dreamwidth.currentDeferral = $.post("dreamwidth",{params:JSON.stringify(params)});
	wizards.registerCallForWizardDisplay(dreamwidth.currentDeferral,"dwResultsText","dwResults");
	return dreamwidth.currentDeferral;
}

dreamwidth.UpdateOutput = function(existingData){
	$("#dwIdentity").text("");
	$("#dwPassword").val("");
	$("#dwUsername").val(existingData.userName);
	$("#dwTimeZone").val(existingData.timezone);
	$("#dwUsername").prop('disabled','disabled');
	var buttons = $( "#dwCredentials" ).dialog( "option", "buttons", [{text:"ok", click: function(){dreamwidth.updateCredentials()}}]);
	dreamwidth.currentOutput = existingData.uniqueId;
	dreamwidth.currentDeferral = $.Deferred();
	wizards.showPage("dwCredentials");
	return dreamwidth.currentDeferral;
}

$(function() {
	$("#dwCredentialsVerify").click(function(){
		var params = {method:"VerifyPassword", username:$("#dwUsername").val(), password:$("#dwPassword").val()};
		var posting = $.post("dreamwidth",{params:JSON.stringify(params)});
		posting.done(function(data){
			var parsedData = $.parseJSON(data);
			$("#dwIdentity").text(parsedData.result);
			wizards.setProperty("dwCredentials","height","auto");
		});
		wizards.registerCallForWizardOnError(posting);
	});
	AddOutput(dreamwidth.sitename, dreamwidth.AddOutput,dreamwidth.UpdateOutput,dreamwidth.RemoveOutput);
});
</script>
