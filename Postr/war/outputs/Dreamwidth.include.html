 <div id="dwCredentials" title="Dreamwidth Details">
	<form>
		<label for=dwUsername>User Name:</label> <input type="text" id="dwUsername" name="username"><BR>
		<label for=dwPassword>Password:</label> <input type="password" id="dwPassword" name="password"><BR>
		<button type="button" id="dwCredentialsVerify">Verify</button><BR>
		<div id="dwIdentity"></div><BR>
		<label for=dwTimeZone>Time Zone:</label><input type=text id="dwTimeZone">
	</form>
 </div>


<script type="text/javascript">

var Dreamwidth = function Dreamwidth(){
	sitename = "Dreamwidth";
	siteID = "dreamwidth";
	usernameID = "#dwUsername";
	passwordID = "#dwPassword";
	timezoneID = "#dwTimeZone";
	credentialsWizard = "#dwCredentials"
	identityID = "#dwIdentity"; 
	verifyID = "#dwCredentialsVerify";
	
	that = this;
	
	saveCredentials = function(){
		if($("#dwIdentity").text() != ""){
			var params = {method:"SaveData", username:$(usernameID).val(), password:$(passwordID).val(), timezone:$(timezoneID).val()};
			var posting = $.post(siteID,{params:JSON.stringify(params)});
			wizards.registerCallForWizardDisplay(posting).done(function(data){
				data.siteName = sitename;
				data.username = params.username;
				data.timezone = params.timezone;
				that.currentDeferral.resolve(data);
			});
		}
		else{
			wizards.showError("Identity not validated");
		}
	}

	updateCredentials = function(){
		if($(identityID).text() != ""){
			var params = {method:"UpdateData", password:$(passwordID).val(), timezone:$(timezoneID).val(), key:that.currentOutput};
			var posting = $.post(siteID,{params:JSON.stringify(params)});
			wizards.registerCallForWizardDisplay(posting).done(function(data){
				data.timezone = params.timezone;
				that.currentDeferral.resolve(data);
			});
		}
		else{
			wizards.showError("Identity not validated");
		}
	}
	
	addOutput = function(){
		$(identityID).text("");
		$(timezoneID).val("");
		$(passwordID).val("");
		$(usernameID).val("");
		$(usernameID).removeProp('disabled');
		var buttons = $(credentialsWizard ).dialog( "option", "buttons", [{text:"ok", click: function(){saveCredentials()}}]);
		that.currentDeferral = $.Deferred();
		wizards.showPage(credentialsWizard);
		return that.currentDeferral;
	}

	removeOutput = function(key){
		var params = {method:"RemoveData", key:parseInt(key)};
		that.currentDeferral = $.post(siteID,{params:JSON.stringify(params)});
		wizards.registerCallForWizardDisplay(that.currentDeferral);
		return that.currentDeferral;
	}

	updateOutput = function(existingData){
		$(identityID).text("");
		$(passwordID).val("");
		$(usernameID).val(existingData.userName);
		$(timezoneID).val(existingData.timezone);
		$(usernameID).prop('disabled','disabled');
		var buttons = $( credentialsWizard ).dialog( "option", "buttons", [{text:"ok", click: function(){updateCredentials()}}]);
		that.currentOutput = existingData.uniqueId;
		that.currentDeferral = $.Deferred();
		wizards.showPage(credentialsWizard);
		return that.currentDeferral;
	}
	
	$(verifyID).click(function(){
		var params = {method:"VerifyPassword", username:$(usernameID).val(), password:$(passwordID).val()};
		var posting = $.post(siteID,{params:JSON.stringify(params)});
		posting.done(function(data){
			var parsedData = $.parseJSON(data);
			$(identityID).text(parsedData.result);
			wizards.setProperty(credentialsWizard,"height","auto");
		});
		wizards.registerCallForWizardOnError(posting);
	});
	AddOutput(sitename, addOutput,updateOutput,removeOutput);

};

$(function() {
	wizards.register("#dwCredentials");

	var dreamwidth = new Dreamwidth();


});
</script>